# AQI Monitor Backend — Design Doc
Cloudflare Workers + D1

---

## 1. Goals

- Support 2–3 physical devices
- Each device reports roughly once per minute
- Initial metrics: PM2.5, AQI
- Future metrics: CO₂, VOC (ppm + index), temperature, relative humidity
- Simple, robust backend using Cloudflare Workers + D1
- Clean API for ingestion, latest readings, and time-series graphs

---

## 2. Core Design Decisions

- **Server time only**  
  Devices do not send timestamps. The Worker timestamps on receipt to avoid clock drift.

- **One row per device per minute**  
  All metrics stored in a single row. Missing metrics are stored as NULL.

- **UTC everywhere**  
  Device timezone is stored only for frontend display.

- **Minimalism over cleverness**  
  No per-metric rows, no streaming, no premature abstractions.

---

## 3. Architecture Overview

Device → HTTP → Cloudflare Worker → SQL → D1  
Device → HTTP → Frontend (Cloudflare Pages)

---

## 4. Data Model (D1 Schema)

### 4.1 Devices
```sql
    CREATE TABLE IF NOT EXISTS devices (
      device_id     TEXT PRIMARY KEY,
      secret_hash   TEXT NOT NULL,
      timezone      TEXT NOT NULL
    );
```
- `device_id`: stable identifier embedded in firmware  
- `secret_hash`: hashed shared secret  
- `timezone`: IANA timezone string (display only)

---

### 4.2 Raw Samples (Minute-Level)

```sql
    CREATE TABLE IF NOT EXISTS samples_raw (
      device_id     TEXT NOT NULL,
      ts            INTEGER NOT NULL,   -- server time, epoch seconds (minute-bucketed)

      pm25_ugm3     REAL,
      aqi_us        INTEGER,

      co2_ppm       REAL,

      voc_ppm       REAL,
      voc_index     REAL,

      temp_c        REAL,
      rh_pct        REAL,

      PRIMARY KEY (device_id, ts),
      FOREIGN KEY (device_id) REFERENCES devices(device_id)
    );

    CREATE INDEX IF NOT EXISTS idx_samples_raw_device_ts
      ON samples_raw(device_id, ts);
```

Notes:
- `ts` is generated by the server and bucketed to the minute  
  `ts = floor(now_epoch_seconds / 60) * 60`
- Ingest uses UPSERT to make retries idempotent

---

### 4.3 Hourly Rollups (Optional)

```sql
    CREATE TABLE IF NOT EXISTS samples_hourly (
      device_id     TEXT NOT NULL,
      hour_ts       INTEGER NOT NULL,   -- epoch seconds at hour boundary

      pm25_avg      REAL,
      pm25_min      REAL,
      pm25_max      REAL,

      aqi_avg       REAL,
      aqi_min       INTEGER,
      aqi_max       INTEGER,

      co2_avg       REAL,
      co2_min       REAL,
      co2_max       REAL,

      voc_ppm_avg   REAL,
      voc_ppm_min   REAL,
      voc_ppm_max   REAL,

      voc_index_avg REAL,
      voc_index_min REAL,
      voc_index_max REAL,

      temp_avg      REAL,
      temp_min      REAL,
      temp_max      REAL,

      rh_avg        REAL,
      rh_min        REAL,
      rh_max        REAL,

      n             INTEGER NOT NULL,

      PRIMARY KEY (device_id, hour_ts),
      FOREIGN KEY (device_id) REFERENCES devices(device_id)
    );

    CREATE INDEX IF NOT EXISTS idx_samples_hourly_device_ts
      ON samples_hourly(device_id, hour_ts);
```

`n` represents the number of raw samples aggregated into the rollup.  
Useful for detecting gaps and validating completeness.

---

## 5. API Contract (v1)

Base path:

    /api/v1

All requests and responses are JSON.

---

### 5.1 Authentication (Device → Server)

HMAC-based authentication.

Each device has:
- `device_id`
- shared secret `S`

Headers:

    X-Device-Id: <device_id>
    X-Signature: <hex(hmac_sha256(S, raw_body))>

The server validates the signature before processing the request.

---

### 5.2 Ingest Sample

POST `/api/v1/ingest`

Request body:

```json
    {
      "pm25_ugm3": 18.2,
      "aqi_us": 63,
      "co2_ppm": 712,
      "voc_ppm": 0.42,
      "voc_index": 108,
      "temp_c": 26.7,
      "rh_pct": 54.1
    }
```

Rules:
- All fields optional
- At least one metric required
- Unknown fields rejected

Server behavior:
- Timestamp using server time
- Bucket to minute
- UPSERT into `samples_raw`

Response:

```json
    {
      "ok": true,
      "ts": 1766925000
    }
```
---

### 5.3 Latest Values

GET `/api/v1/devices/{device_id}/latest`

```json
    {
      "device_id": "tinys3-livingroom-01",
      "ts": 1766925000,
      "metrics": {
        "pm25_ugm3": 18.2,
        "aqi_us": 63,
        "co2_ppm": 712,
        "voc_ppm": 0.42,
        "voc_index": 108,
        "temp_c": 26.7,
        "rh_pct": 54.1
      }
    }
```
---

### 5.4 Time-Series Query (Graphs)

GET `/api/v1/devices/{device_id}/series`

Query parameters:
- `metric`: pm25_ugm3 | aqi_us | co2_ppm | voc_ppm | voc_index | temp_c | rh_pct
- `from`: epoch seconds
- `to`: epoch seconds
- `resolution`: raw | 1h

Raw example:

```json
    {
      "metric": "pm25_ugm3",
      "resolution": "raw",
      "points": [
        { "ts": 1766924400, "value": 17.9 },
        { "ts": 1766924460, "value": 18.1 }
      ]
    }
```
Hourly example:

```json
    {
      "metric": "pm25_ugm3",
      "resolution": "1h",
      "points": [
        {
          "ts": 1766922000,
          "avg": 19.2,
          "min": 12.1,
          "max": 28.4,
          "n": 58
        }
      ]
    }
```
---

### 5.5 Health Check

GET `/api/v1/health`

```json
    {
      "ok": true
    }
```

Notes:
- Fast, no-DB request for uptime checks and load balancers
---

## 6. Aggregation & Retention

Aggregation:
- Worker cron every 10 minutes
- Aggregate completed hours only
- Write to `samples_hourly`

Retention (recommended):
- `samples_raw`: 90 days
- `samples_hourly`: 2+ years

---

## 7. Rationale

- Simple SQL
- Easy sensor expansion
- No clock drift
- Idempotent writes
- Fast dashboards and historical graphs
- Well within Cloudflare free tier
